<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Mapper | A Full Stack JS Book</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro/intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="intro/rest_basics.html"><strong aria-hidden="true">1.1.</strong> RESTful API Basics</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Backend</li><li class="chapter-item expanded "><a href="chapter_1/setup_api_server.html"><strong aria-hidden="true">2.</strong> Setup API Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_1/prerequisites.html"><strong aria-hidden="true">2.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="chapter_1/create_project.html"><strong aria-hidden="true">2.2.</strong> Create Project</a></li><li class="chapter-item expanded "><a href="chapter_1/basic_express_app.html"><strong aria-hidden="true">2.3.</strong> Basic Express App</a></li><li class="chapter-item expanded "><a href="chapter_1/docker_files.html"><strong aria-hidden="true">2.4.</strong> Create Docker Files</a></li><li class="chapter-item expanded "><a href="chapter_1/github_repo.html"><strong aria-hidden="true">2.5.</strong> Create GitHub Repo</a></li></ol></li><li class="chapter-item expanded "><a href="chapter_2/api_design.html"><strong aria-hidden="true">3.</strong> Design and Build API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_2/mongo.html"><strong aria-hidden="true">3.1.</strong> Connect Mongo</a></li><li class="chapter-item expanded "><a href="chapter_2/models.html"><strong aria-hidden="true">3.2.</strong> Models</a></li><li class="chapter-item expanded "><a href="chapter_2/routing.html"><strong aria-hidden="true">3.3.</strong> Routing</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Testing API</div></li><li class="chapter-item expanded affix "><li class="part-title">Frontend</li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Setup React App</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Mapper | A Full Stack JS Book</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/duanebester/map-api-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction" id="introduction">Introduction</a></h1>
<h3><a class="header" href="#about-me" id="about-me">About Me</a></h3>
<p>Hi there! My name is Duane Bester. My background is in Electrical Engineering, but I have been writing professional software for over ten years now. I've been involved in various different startups with projects that have ranged from Virtual Reality-- Sensors and Hardware Design, to full stack web applications and ETL pipelines-- ingesting hundreds of thousands of articles a day. This has given me the ability to learn and use many software languages and frameworks over the years. I believe in learning by doing, so we will skip a lot of mundane programming theory and build something practical in a short amount of time.</p>
<h3><a class="header" href="#plot" id="plot">Plot</a></h3>
<p>Imagine we have data that contains GPS coordinates, like locations of earthquakes. We would like to display our data on a map in a <a href="https://reactjs.org/">React</a> application. We also want to save User and Earthquake data in MongoDB (eventually using <a href="https://www.mongodb.com/cloud/atlas">Mongo Atlas</a>). The app will have a robust RESTful API written with the <a href="https://expressjs.com/">Express</a> framework in Node.js. We will also leverage Docker to run services locally as well as for deploying this application to any cloud provider. </p>
<p>This book will cover getting up and running with the basics of a full-stack application:</p>
<ul>
<li>React
<ul>
<li>Displaying Data with Mapbox</li>
<li>Material UI 
<ul>
<li>React Components</li>
<li>Loading Screens / Skeletons</li>
</ul>
</li>
<li>React Testing Library</li>
</ul>
</li>
<li>Node.js
<ul>
<li>Express API Framework
<ul>
<li>Middle-ware</li>
</ul>
</li>
<li>Testing</li>
<li>User Authentication</li>
</ul>
</li>
<li>MongoDB
<ul>
<li>ORM - Mongoose Driver</li>
</ul>
</li>
</ul>
<p>As well as the tools &amp; services:</p>
<ul>
<li>Docker</li>
<li>cURL</li>
<li>VSCode</li>
<li>Git &amp; GitHub</li>
<li>Cloud Providers
<ul>
<li>Digital Ocean</li>
<li>Google Cloud</li>
<li>Amazon Web Services</li>
<li>Mongo Atlas</li>
</ul>
</li>
</ul>
<p>At the end, I'll provide a link to the full working source code in GitHub. Let's get started!</p>
<h1><a class="header" href="#restful-api-basics" id="restful-api-basics">RESTful API Basics</a></h1>
<h3><a class="header" href="#api" id="api">API</a></h3>
<p>To understand what a RESTful API is, we need to understand what an API is.</p>
<p>API stands for &quot;<strong>A</strong>pplication <strong>P</strong>rogramming <strong>I</strong>nterface&quot; and is &quot;a computing interface that defines interactions between multiple software intermediaries. It defines the kinds of calls or requests that can be made, how to make them, the data formats that should be used, the conventions to follow&quot; - Wikipedia.</p>
<p>We can think of an API almost as a set of rules and conditions that we expect software to adhere to. There is no magic to this-- we can define an API any way we like. Let's define a simple one:</p>
<p>Our API (version 1.0):</p>
<ul>
<li>You give me any number, and I'll return that number.</li>
<li>You give me any two numbers, and I'll give you their product.</li>
</ul>
<p>That's all it takes! The above is a totally legit API. Just a list of bullet points.</p>
<p>An API is just a way to define a set of rules. It was invented to allow software developers to modularize their code. You could take the above API definition, hand it to any software developer, and they can write the code that adheres to the rules.</p>
<p>E.g.</p>
<pre><code class="language-ignore">Input x, y:
    If y is Undefined
        Set y = 1

    Return (x * y)
</code></pre>
<p>But this API isn't fool-proof... What happens if we were given something other than numbers? We can totally add or multiply <code>'a'</code> and <code>'b'</code>, but it might not be what you expect. For example, in JavaScript:</p>
<pre><code class="language-js">console.log('a' + 'b');
// Returns 'ab'
console.log('a' * 'b');
// Returns NaN (Not A Number)
</code></pre>
<p>Luckily we can extend an API. Let's say version 1.0 is deprecated and everyone must use our newly extended API:</p>
<p>Our API (version 2.0):</p>
<ul>
<li>You give me any number, and I'll return that number.</li>
<li>You give me any two numbers, and I'll give you their product.</li>
<li>Can only enter numbers, entering anything else returns an error message.</li>
</ul>
<p>E.g.</p>
<pre><code class="language-ignore">Input x, y:
    If x is Undefined
        Return Error

    If x isNot Number
        Return Error

    If y is Undefined
        Set y = 1

    If y isNot Number
        Return Error

    Return x * y
</code></pre>
<p>The nice thing about this is you could define multiple API specifications and then stitch them all together. An API, for example, can be the bridge between two software developers. Bob is writing some code for a Math library and needs a function for multiplication. Jim has some free time and can write the multiplication code. Bob and Jim agree on an API, such that as long as Jim's code meets the API definition, we can combine the two pieces of code together when they have both finished. Modularization.</p>
<p>Our list of bullet-points totally works, but code is much more succinct, and can be Type checked. In Typescript, Bob can define the interface as a function. Same as our bullet-points, the function takes a number and a second optional number. It then returns a number. He can then continue on his day writing other code that would call this function:</p>
<pre><code class="language-ts">interface IMath {
    multiply: (x:Number, y?:Number) =&gt; Number
}
</code></pre>
<p>Jim would then write the implementation. Same as the bullet-point logic; If the type of the first input isn't a number, return an error. If the type of the second input isn't defined, we set it to <code>1</code>. If the second input was defined, but it's not a number, return an error. Otherwise if all is good, return the multiplication of the two inputs:</p>
<pre><code class="language-ts">var math:IMath = {
    multiply: (x:Number, y?:Number) =&gt; {
        if(typeof x !== 'number') throw new Error()
        if(typeof y === 'undefined') y = 1
        if(typeof y !== 'number') throw new Error()
        return x * y
    }
}
</code></pre>
<p>Bob could then use Jim's implementation in his code:</p>
<pre><code class="language-ts">console.log(math.multiply(2))   // 2
console.log(math.multiply(2,3)) // 6
</code></pre>
<p>Voila, we are interface masters. just created a simple interface and the implementation of that interface... Remember that API stands for Application Programming <strong>Interface</strong>? This basically means that a whole <em>Application</em> has an <em>Interface</em>.</p>
<p>So a better example of an <em>API</em> versus <em>just the I</em> might look more like this:</p>
<pre><code class="language-ts">interface IMath {
    add: (x:Number, y?:Number) =&gt; Number
    subtract: (x:Number, y?:Number) =&gt; Number
    multiply: (x:Number, y?:Number) =&gt; Number
    divide: (x:Number, y?:Number) =&gt; Number
}
</code></pre>
<h3><a class="header" href="#rest" id="rest">REST</a></h3>
<p>REST stands for &quot;<strong>RE</strong>presentational <strong>S</strong>tate <strong>T</strong>ransfer&quot; and a RESTful Web service is required to provide an application access to its Web resources in a textual representation. - Wikipedia</p>
<p>This interpretation doesn't win awards for being clear. A RESTful API <em>could be many things,</em> but the community has largely accepted that sending Http Requests and Responses in a certain manner constitutes as RESTful. A RESTful API is the bridge between the &quot;Frontend&quot; and &quot;Backend&quot; code that is needed to build a web application. They communicate via the API. Backend code is usually the server that connects to a database and performs business logic on said data before sending it to a Frontend. The Frontend is usually an application that runs in the browser that makes the business logic and data make sense to users. The Frontend also handles user input and interactions. Why split the two? Again, for Modularization. The two areas have become complex enough that they require more expertise. Thus web applications are largely split.</p>
<p>For us to build a RESTful API we need to focus on three attributes of an Http Request:</p>
<ul>
<li>Method</li>
<li>Path</li>
<li>Body</li>
</ul>
<p>Request Headers are important for Http, frameworks, and Auth. However, for basic RESTful model design, we won't worry about them.</p>
<pre><code class="language-ts">Request {
    Path: String
    Body: String | Object
    Method: String
    Headers: Object
}
</code></pre>
<p>The Http Request Path is the URL endpoint. If we had a URL such as <code>https://my-website.com/api/users</code> the path would be <code>/api/users</code>.</p>
<pre><code class="language-ts">Request {
    Path: &quot;/api/users&quot;
}
</code></pre>
<p>The Body of an Http Request is the data the Request contains. For our purposes, this will be a JSON document with info we want to send to our service.</p>
<pre><code class="language-ts">Request {
    Body: { name: &quot;John&quot;, age: 30 }
}
</code></pre>
<p>An Http Request Method is usually one of the following; <code>GET</code>, <code>PUT</code>, <code>POST</code>, <code>DELETE</code>. (There are many others, but these are the most common).</p>
<pre><code class="language-ts">Request {
    Method: &quot;POST&quot;
}
</code></pre>
<p>With the above three attributes, we can build a RESTful service for a User resource (often called a Model). The most common, and usually the default way to represent state transfer for a model is called &quot;CRUD&quot; which stands for Create, Read, Update, and Delete. This makes sense as if we have a User model, we would likely want to create users, retrieve users, update them, and perhaps delete them.</p>
<p>Say we want to <strong>get</strong> the <strong>users</strong> from our service, we'd send an Http Request with the method set to <strong>GET</strong> and the path set to <strong>/api/users</strong>:</p>
<blockquote>
<p>Note that we don't need to send any info in the Body to retrieve users.</p>
</blockquote>
<pre><code class="language-ts">GetUsersRequest {
    Path: &quot;/api/users&quot;
    Body: {}
    Method: &quot;GET&quot;
}
</code></pre>
<p>And if we wanted to create a new user:</p>
<pre><code class="language-ts">AddUserRequest {
    Path: &quot;/api/users&quot;
    Body: { name: &quot;John&quot;, age: 30 }
    Method: &quot;POST&quot;
}
</code></pre>
<p>And if we wanted to update the user's age (we need the ID of the user in the Path):</p>
<pre><code class="language-ts">UpdateUserRequest {
    Path: `/api/users/&lt;user-id&gt;`
    Body: { name: &quot;John&quot;, age: 31 }
    Method: &quot;PUT&quot;
}
</code></pre>
<p>And if we wanted to delete the user (we need the ID of the user in the Path):</p>
<pre><code class="language-ts">DeleteUserRequest {
    Path: `/api/users/&lt;user-id&gt;`
    Body: {}
    Method: &quot;DELETE&quot;
}
</code></pre>
<p>With the above RESTful API defined, the Frontend developers can build an application that queries for users. Similarly, the backend developers can build their code to serve up users and ways to modify users. Once both sides have completed their code, the whole system works together.</p>
<h1><a class="header" href="#setup-api-server" id="setup-api-server">Setup API Server</a></h1>
<p>For our Map project, we need a robust and easy to use API Server. Luckily <a href="https://expressjs.com/">Express.js</a> fits these requirements and has a nice DSL to work with. <em>&quot;Express is a minimal and flexible Node.js web application framework that provides a robust set of features for web and mobile applications.&quot;</em></p>
<blockquote>
<p>Why not Koa?</p>
</blockquote>
<p><em>A note about Koa. Koa is robust, minimal, and widely regarded as the next Express.js framework. However, I firmly believe that for beginners it's easier to understand Express. Working through this course will definitely go a long way to understanding Koa as well.</em></p>
<p>The most basic Express app that returns &quot;Hello world&quot; for all GET requests is:</p>
<pre><code class="language-js">const express = require('express');
const app = express();
const port = 8080;

app.get('/', (req, res) =&gt; {
  res.send('Hello World!')
});

app.listen(port, () =&gt; {
  console.log(`Example app running on port: ${port}`)
});
</code></pre>
<p>I encourage you to read the overview on the <a href="https://expressjs.com/">Express</a> to gain some intuition</p>
<h1><a class="header" href="#prerequisites" id="prerequisites">Prerequisites</a></h1>
<h4><a class="header" href="#tools" id="tools">Tools</a></h4>
<ul>
<li>Install <a href="https://nodejs.org/en/download/">Node 14 LTS</a></li>
<li>Install <a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>
<ul>
<li>Make sure Docker is running after install!</li>
</ul>
</li>
<li>Install <a href="https://code.visualstudio.com/">VSCode</a></li>
<li>Install <a href="https://git-scm.com/">Git</a>
<ul>
<li>Apple ships Git with XCode, so on a mac you <em>shouldn't</em> need to install it.</li>
</ul>
</li>
</ul>
<h4><a class="header" href="#accounts" id="accounts">Accounts</a></h4>
<ul>
<li>Create a <a href="https://github.com/">GitHub</a> Account</li>
<li>Create a <a href="https://digitalocean.com/">DigitalOcean</a> Account</li>
<li>Create a <a href="https://account.mapbox.com/">Mapbox</a> Account</li>
</ul>
<h3><a class="header" href="#verifying-installs" id="verifying-installs">Verifying Installs</a></h3>
<p>Open a terminal, type and enter:</p>
<pre><code class="language-bash">docker ps
# Returns: CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
</code></pre>
<p>Same terminal, type and enter:</p>
<pre><code class="language-bash">node --version
# Returns: v14.15.5 or similar
</code></pre>
<p>Same terminal, type and enter:</p>
<pre><code class="language-bash">git --version
# Returns: git version 2.24.3 (Apple Git-128)
</code></pre>
<h4><a class="header" href="#node-version" id="node-version">Node Version</a></h4>
<p>My local Node version at time of writing is <code>v14.15.5</code></p>
<h5><a class="header" href="#dependencies" id="dependencies">Dependencies</a></h5>
<p>There is a chance you'll be using newer dependency versions, if you run into errors in the later sections, here are my Node dependency versions at time of writing:</p>
<pre><code class="language-json">  &quot;dependencies&quot;: {
    &quot;compression&quot;: &quot;^1.7.4&quot;,
    &quot;cors&quot;: &quot;^2.8.5&quot;,
    &quot;express&quot;: &quot;^4.17.1&quot;,
    &quot;helmet&quot;: &quot;^4.4.1&quot;,
    &quot;mongoose&quot;: &quot;^5.11.16&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;jest&quot;: &quot;^26.6.3&quot;,
    &quot;nodemon&quot;: &quot;^2.0.7&quot;,
    &quot;supertest&quot;: &quot;^6.1.3&quot;
  }
</code></pre>
<h1><a class="header" href="#create-project" id="create-project">Create Project</a></h1>
<p>Create a new directory, <code>map-api</code> and then change directory into it:</p>
<pre><code class="language-bash">mkdir map-api
cd map-api
</code></pre>
<p>Create an NPM project:</p>
<pre><code class="language-bash">npm init -y
</code></pre>
<h4><a class="header" href="#install-dependencies" id="install-dependencies">Install dependencies</a></h4>
<p>Application dependencies:</p>
<pre><code class="language-bash">npm i express cors compression helmet
</code></pre>
<p>Development dependencies:</p>
<pre><code class="language-bash">npm i -D nodemon jest supertest
</code></pre>
<h4><a class="header" href="#app-files" id="app-files">App files</a></h4>
<blockquote>
<p>Note: In the root directory of the project</p>
</blockquote>
<p>Make a new file called <code>index.js</code>.</p>
<pre><code class="language-bash">touch index.js
</code></pre>
<p>Make a new file called <code>app.js</code>.</p>
<pre><code class="language-bash">touch app.js
</code></pre>
<p>Make a new file called <code>app.test.js</code>.</p>
<pre><code class="language-bash">touch app.test.js
</code></pre>
<p>Make a new file called <code>Dockerfile</code>.</p>
<pre><code class="language-bash">touch Dockerfile
</code></pre>
<p>Make a new file called <code>.dockerignore</code>.</p>
<pre><code class="language-bash">touch .dockerignore
</code></pre>
<p>Make a new file called <code>docker-compose.yml</code>.</p>
<pre><code class="language-bash">touch docker-compose.yml
</code></pre>
<h1><a class="header" href="#basic-express-app" id="basic-express-app">Basic Express App</a></h1>
<h3><a class="header" href="#create-the-app" id="create-the-app">Create the App</a></h3>
<p>Edit app.js:</p>
<pre><code class="language-js">const express = require('express');
const app = express();

app.get('/', (req, res) =&gt; {
  res.send('Hello World!');
});

module.exports = app;
</code></pre>
<p>Edit index.js:</p>
<pre><code class="language-js">const app = require('./app');
// Default the port to 8080
const port = process.env.PORT || 8080;

app.listen(port, () =&gt; {
  console.log(`App running on port: ${port}`)
});
</code></pre>
<p>Edit package.json, add a <code>&quot;start&quot;</code> property to the <code>&quot;scripts&quot;</code> object:</p>
<pre><code class="language-json">  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;nodemon index.js&quot;
  },
</code></pre>
<h3><a class="header" href="#run-the-app" id="run-the-app">Run the App</a></h3>
<p>We can now run our very basic app:</p>
<pre><code class="language-bash">npm run start
</code></pre>
<p>If we go to <a href="http://localhost:8080">localhost:8080</a>, we should see <code>Hello world</code>! This is cool, so let's create a simple test for our  API to verify this functionality.</p>
<blockquote>
<p>Nodemon will watch any code changes we make and automatically reload our server. </p>
</blockquote>
<p>We can stop our server from running with (Cmd or Ctrl) + C.</p>
<h3><a class="header" href="#test-the-app" id="test-the-app">Test the App</a></h3>
<p>Add a <code>&quot;jest&quot;:</code> section to the <code>package.json</code> file:</p>
<pre><code class="language-json">  &quot;jest&quot;: {
    &quot;testEnvironment&quot;: &quot;node&quot;,
    &quot;coveragePathIgnorePatterns&quot;: [
      &quot;/node_modules/&quot;
    ]
  },
</code></pre>
<p>And then add the <code>&quot;test&quot;</code> script to the <code>&quot;scripts&quot;:</code> section of the <code>package.json</code> file:</p>
<pre><code class="language-json">  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;nodemon index.js&quot;,
    &quot;test&quot;: &quot;NODE_ENV=test jest --runInBand  --testTimeout=10000&quot;,
  }
</code></pre>
<blockquote>
<p>Note: the --runInBand option will tell Jest to run the tests serially in the current process</p>
</blockquote>
<p>Now we add the following in <code>app.test.js</code> which just checks that a request to our endpoint returns a Status: 200 - Success, and the <code>Hello World!</code> body:</p>
<pre><code class="language-js">const request = require('supertest');
const app = require('./app');

describe('GET /', () =&gt; {
  it('responds with Hello World', (done) =&gt; {
    function hasHelloWorld(res) {
      if ('Hello World!' !== res.text) throw new Error(&quot;Missing Hello World!&quot;);
    }
    request(app)
      .get('/')
      .expect(200)
      .expect(hasHelloWorld)
      .end(done)
  });
});
</code></pre>
<p>We can now run the following to test our simple app (make sure server isn't running):</p>
<pre><code class="language-bash">npm run test
</code></pre>
<p>We should see our test passes! </p>
<pre><code class="language-bash"> PASS  ./app.test.js
  GET /
    âœ“ responds with Hello World (23 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        0.645 s, estimated 1 s
Ran all test suites.
</code></pre>
<p>Onward, to creating Docker files.</p>
<h1><a class="header" href="#docker-files" id="docker-files">Docker Files</a></h1>
<p>Edit the <code>Dockerfile</code>: </p>
<pre><code class="language-Dockerfile">FROM node:lts-alpine

COPY . .

RUN npm i

EXPOSE 8080

CMD [ &quot;node&quot;, &quot;index.js&quot; ]
</code></pre>
<p>Edit the <code>.dockerignore</code> file: </p>
<pre><code class="language-ignore">.git
node_modules/
</code></pre>
<p>We are going to use a Mongo instance (v4.4) that has some Earthquake data pre-loaded.
Edit the <code>docker-compose.yml</code> file: </p>
<pre><code class="language-yml">version: '3.8'
services:
  mongo:
    image: 'duanebester/mongo-earthquakes:latest'
    container_name: 'mongo-earthquakes'
    volumes: 
      - ./mongo-volume:/data/db
    ports:
      - '27017-27019:27017-27019'
</code></pre>
<p>At this point, we can run the following command to start up a Mongo Database!</p>
<pre><code class="language-bash">docker-compose up -d
</code></pre>
<p>It will take a while, but your Mongo instance should come up. We can verify by running:</p>
<pre><code class="language-bash">&gt; docker ps
# Returns:
# CONTAINER ID   IMAGE                   
# ............   mongo-earthquakes:latest
</code></pre>
<p>To stop the running containers, run:</p>
<pre><code class="language-bash">docker-compose down
</code></pre>
<p>The nice thing about Docker Compose is that we can <em>compose</em> several services together. Say we also wanted to add a Postgres Database. We would do so by adding the following <code>postgres:</code> section below the <code>mongo:</code> section:</p>
<pre><code class="language-yml">  mongo:
    ...
  postgres:
    image: 'postgres:12'
    container_name: 'postgresdb'
    environment: 
      - POSTGRES_DB=map
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    ports: 
      - '5432:5432'
</code></pre>
<p>Now we can run <code>docker-compose up -d</code> and <code>docker-compose down</code> to start and stop both Mongo and Postgres!</p>
<p>The <code>up</code> command will create and start all containers in the <code>docker-compose.yml</code> file.
Similarly, the <code>down</code> command will stop and remove all containers in the <code>docker-compose.yml</code> file.</p>
<p>To <em>just</em> start the Mongo container. run:</p>
<pre><code class="language-bash">docker-compose up --no-start
docker-compose start mongo
</code></pre>
<p>To stop <em>just</em> the Mongo container:</p>
<pre><code class="language-bash">docker-compose stop mongo
</code></pre>
<p>Note that this doesn't remove/delete the container, just stops it from running.</p>
<p>We aren't going to use Postgres, so you can stop all containers (<code>docker-compose down</code>) and remove the <code>postgres:</code> section from the <code>docker-compose.yml</code> file.</p>
<blockquote>
<p>Removing unused Docker objects...</p>
</blockquote>
<p>Sometimes after lots of development, you'll get &quot;Out of space&quot; warnings. Usually related to dangling volumes/images/etc. These are resources that we can remove, but then we will lose any saved data. I recommend removing these every now and then:</p>
<pre><code class="language-bash">docker system prune
</code></pre>
<p>Volumes aren't removed by default, so to remove those as well:</p>
<pre><code class="language-bash">docker system prune -a
</code></pre>
<h1><a class="header" href="#create-github-repo" id="create-github-repo">Create GitHub Repo</a></h1>
<p>Login to <a href="https://github.com">GitHub</a> and <a href="https://github.com/new">Create a Repository</a>.</p>
<p>Give it a name, like <code>map-api</code>. </p>
<p>I'll keep mine public and I <strong>won't</strong> create the README, .gitignore, or License files at this time.</p>
<p>Click <code>Create Repository</code>.</p>
<p>It will then display instructions on how to add code... Head back to VSCode. In the terminal, in the project directory, enter:</p>
<pre><code class="language-bash">git init
# Returns: Initialized empty Git repository ...
</code></pre>
<blockquote>
<p>At this point, we want to create a <code>.gitignore</code> file! </p>
</blockquote>
<pre><code class="language-bash">touch .gitignore
</code></pre>
<p>Any files or folders we list in the <code>.gitignore</code> will be ignored by Git and won't be pushed to our remote repository.</p>
<p>Edit <code>.gitignore</code> and add <code>node_modules/</code>, and <code>mongo-volume/</code>:</p>
<pre><code class="language-ignore">node_modules/
mongo-volume/
</code></pre>
<p>Then enter;</p>
<pre><code class="language-bash">git add --all
git commit -m &quot;First commit - basic express app&quot;
# Returns: create mode...
git branch -M main
</code></pre>
<p>The instructions on GitHub will tell you to add the remote origin, something like this (replace <code>&lt;your-username&gt;</code> below):</p>
<pre><code class="language-bash">git remote add origin git@github.com:&lt;your-username&gt;/map-api.git
</code></pre>
<p>We can now push our code to GitHub! Enter;</p>
<pre><code class="language-bash">git push -u origin main
</code></pre>
<p>Now if we refresh the GitHub page with the instructions on it, it will have all of our code!</p>
<h1><a class="header" href="#design-and-build-api" id="design-and-build-api">Design and Build API</a></h1>
<p>One of the biggest problems with software today is that people do not spend enough time in the &quot;design&quot; phase. It has become easier to iterate and change code, but if we spend some extra time in the beginning to think through our system, we will mitigate a lot of potential changes.</p>
<p>Why Mongo?</p>
<p>Mongo is a NoSQL database, which mostly means it is more free-form and offers us some flexibility in the prototyping phase. It also has a nice way to query and aggregate with GPS coordinates. Mongo documents are essentially JSON documents, so Mongo works well with JavaScript based applications. </p>
<p>So right now our system might be something like this:</p>
<p><img src="chapter_2/../assets/app_design.png" alt="System One" /></p>
<p>We can then think of what we want our API endpoints to look like. For retrieving Earthquakes, perhaps something like:</p>
<table><thead><tr><th>Operation</th><th>Request Method</th><th>Request Path</th><th>Response Status</th><th>Response Body</th></tr></thead><tbody>
<tr><td>Get Quakes</td><td>GET</td><td><code>/api/&lt;version&gt;/earthquakes</code></td><td>200</td><td>[Earthquake]</td></tr>
</tbody></table>
<p>And if we wanted to limit the amount of earthquakes returned, we can add a <code>limit</code> query param to the path of the above:</p>
<pre><code class="language-ignore">/api/&lt;version&gt;/earthquakes?limit=10
</code></pre>
<p>And to paginate through our earthquakes, a <code>skip</code> query param:</p>
<pre><code class="language-ignore">/api/&lt;version&gt;/earthquakes?limit=10&amp;skip=10
</code></pre>
<p>To find earthquakes near a certain coordinate, we could setup a long,lat query param called <code>near</code>:</p>
<pre><code class="language-ignore">/api/&lt;version&gt;/earthquakes?near=[longitude,latitude]
</code></pre>
<p>We could also pass min and max distances (from above GPS point) as query params, but for now we will just let the API default those to something reasonable.</p>
<blockquote>
<p>It's usually best practice to version API's. We can then support multiple versions of the Get Earthquakes endpoint.</p>
</blockquote>
<p>For &quot;CRUD&quot; (Creating, Retrieving, Updating and Deleting) Users, a flushed out API might look like this:</p>
<blockquote>
<p>The <code>5</code> in the Request Path below represents the User's ID</p>
</blockquote>
<table><thead><tr><th>Operation</th><th>Request Method</th><th>Request Body</th><th>Request Path</th><th>Response Status</th><th>Response Body</th></tr></thead><tbody>
<tr><td>Get Users</td><td>GET</td><td></td><td>/api/v1/users</td><td>200</td><td>[User]</td></tr>
<tr><td>Get User By ID</td><td>GET</td><td></td><td>/api/v1/users/5</td><td>200</td><td>User</td></tr>
<tr><td>Create User</td><td>POST</td><td>User</td><td>/api/v1/users</td><td>201</td><td>User</td></tr>
<tr><td>Update User</td><td>PUT</td><td>User</td><td>/api/v1/users/5</td><td>200</td><td>User</td></tr>
<tr><td>Delete User</td><td>DELETE</td><td></td><td>/api/v1/users/5</td><td>204</td><td></td></tr>
</tbody></table>
<h1><a class="header" href="#connect-mongo" id="connect-mongo">Connect Mongo</a></h1>
<blockquote>
<p>Remember to have Mongo running via Docker (<code>docker-compose up -d</code>)!</p>
</blockquote>
<p>To connect to our instance of Mongo running locally we are going to install and use the Mongoose library:</p>
<pre><code class="language-bash">npm install mongoose
</code></pre>
<p>We then make a file <code>db.js</code> with the following:</p>
<pre><code class="language-js">const mongoose = require('mongoose')

function connect(dbUrl) {
  mongoose.set('useNewUrlParser', true)
  mongoose.set('useFindAndModify', false)
  mongoose.set('useCreateIndex', true)
  mongoose.set('useUnifiedTopology', true)
  mongoose.connect(dbUrl)
}

function close() {
  mongoose.connection.close()
}

const db = {
  connect,
  close
};

module.exports = db
</code></pre>
<p>If we want to get more info about the Database connection, we can add the following into our <code>connect</code> function:</p>
<pre><code class="language-js">function connect(dbUrl) {
  // ...previous code...

  mongoose.connection.once('open', () =&gt; {
    console.log('Connected to database');
  });
  mongoose.connection.on('error', err =&gt; {
    console.error(err);
    console.log('MongoDB connection failed: ' + dbUrl);
    process.exit();
  });
}
</code></pre>
<p>We need to require our db instance in our <code>index.js</code> file:</p>
<pre><code class="language-js">const db = require('./db');

db.connect('mongodb://localhost:27017/map');
</code></pre>
<p>Now when we start our app (<code>npm run start</code>) we will see this:</p>
<pre><code class="language-bash">...
[nodemon] starting `node index.js`
App running on port: 8080
Connected to database
</code></pre>
<p>Connected to database! </p>
<blockquote>
<p>Note: Don't worry about any warnings for now.</p>
</blockquote>
<p>Let's define some Schemas for our Models with Mongoose!</p>
<h1><a class="header" href="#models" id="models">Models</a></h1>
<p>A User, to us, might need properties such as:</p>
<ul>
<li>First Name</li>
<li>Last Name</li>
<li>Email</li>
</ul>
<p>But what about on the backend? We'd probably also need:</p>
<ul>
<li>ID</li>
<li>Password</li>
<li>Date Created</li>
<li>Date Updated</li>
</ul>
<p>And perhaps we'd like to support User sessions?</p>
<ul>
<li>Session ID</li>
</ul>
<p>And tracking the User's last login?</p>
<ul>
<li>Last Login Date</li>
</ul>
<p>And supporting forgot password flows?</p>
<ul>
<li>Phone Number</li>
<li>Email Verified</li>
<li>Verification Code</li>
</ul>
<p>The list goes on and on... For now, let's start simple:</p>
<h3><a class="header" href="#user" id="user">User</a></h3>
<ul>
<li>ID</li>
<li>Email</li>
<li>Password</li>
<li>Favorites (list of Earthquakes)</li>
</ul>
<h3><a class="header" href="#earthquake" id="earthquake">Earthquake</a></h3>
<ul>
<li>ID</li>
<li>Year</li>
<li>Area</li>
<li>Scale</li>
<li>Location
<ul>
<li>Latitude</li>
<li>Longitude</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#schemas--models" id="schemas--models">Schemas &amp; Models</a></h2>
<p>We will build the Earthquake schema first, following the guide from <a href="https://mongoosejs.com/docs/geojson.html">Mongoose geo-JSON docs</a>. Create a file called <code>models.js</code>:</p>
<pre><code class="language-js">const mongoose = require('mongoose');
const { Schema } = mongoose;

const earthquakeSchema = new Schema({
  source: String,
  year: Number,
  area: String,
  scale: Number,
  location: {
    _id: false,
    type: {
      type: String,
      enum: ['Point'],
      required: true
    },
    coordinates: {
      // longitude, latitude
      type: [Number],
      required: true
    }
  }
});
</code></pre>
<blockquote>
<p>Note that longitude comes before latitude in the coordinate array.</p>
</blockquote>
<p>Our Earthquake Model can be defined like so:</p>
<pre><code class="language-js">const Earthquake = mongoose.model('Earthquake', earthquakeSchema, 'earthquakes');
</code></pre>
<p>Now we can build our User Schema and Model:</p>
<pre><code class="language-js">const userSchema = new Schema({
  email: {
    type: String,
    required: true,
    unique: true
  },
  password: {
    type: String,
    required: true
  },
  favorites: [{
    type: Schema.Types.ObjectId,
    ref: 'Earthquake',
  }],
}, { timestamps: true });

const User = mongoose.model('User', userSchema);
</code></pre>
<blockquote>
<p>Note: The <code>{ timestamps: true }</code> config object tells Mongoose to automatically add <code>createdAt</code> and <code>updatedAt</code> timestamps to our Model.</p>
</blockquote>
<p>And finally export both Models:</p>
<pre><code class="language-js">module.exports = { User, Earthquake };
</code></pre>
<h1><a class="header" href="#routing" id="routing">Routing</a></h1>
<p>From our design section, our User routes will look like so:</p>
<table><thead><tr><th>Operation</th><th>Request Method</th><th>Request Body</th><th>Request Path</th><th>Response Status</th><th>Response Body</th></tr></thead><tbody>
<tr><td>Get Users</td><td>GET</td><td></td><td>/api/v1/users</td><td>200</td><td>[User]</td></tr>
<tr><td>Get User By ID</td><td>GET</td><td></td><td>/api/v1/users/:id</td><td>200</td><td>User</td></tr>
<tr><td>Create User</td><td>POST</td><td>User</td><td>/api/v1/users</td><td>201</td><td>User</td></tr>
<tr><td>Update User</td><td>PUT</td><td>User</td><td>/api/v1/users/:id</td><td>200</td><td>User</td></tr>
<tr><td>Delete User</td><td>DELETE</td><td></td><td>/api/v1/users/:id</td><td>204</td><td></td></tr>
</tbody></table>
<p>Which we can represent using Express' DSL.</p>
<p>But first, let's import our User model into <code>app.js</code>:</p>
<pre><code class="language-js">const express = require('express');
const { User } = require('./models');
const app = express();
</code></pre>
<p>Now we can add our routes for Users:</p>
<pre><code class="language-js">app.get('/users', (req, res) =&gt; {
  const users = await User.find({});
  res.status(200).send(users)
})

app.get('/users/:id', (req, res) =&gt; {
  const id = req.params.id;
  const user = await User.findOneById(id);
  res.status(200).send(user)
})

app.post('/users', (req, res) =&gt; {
  const newUser = await User.create(req.body);
  res.status(201).send(newUser)
})

app.put('/users:id', (req, res) =&gt; {
  const id = req.params.id;
  const newUser = await User.findByIdAndUpdate(id, req.body);
  res.status(200).send(updatedUser)
})

app.delete('/users/:id', async (req, res) =&gt; {
  const id = req.params.id;
  await User.findByIdAndRemove(id);
  res.status(204).send()
})
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
